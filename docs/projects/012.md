---
nav_order: 60
parent: 프로젝트
title: '[DONE] Feature 상관관계 분석 및 예측력 진단'
---

# Feature 상관관계 분석 및 예측력 진단
{:.no_toc}

## 목차
{:.no_toc}

1. TOC
{:toc}

---

| 상태 | 생성일 | 수정일 |
|------|--------|--------|
| completed | 2025-12-19 | 2025-12-19 |

---

## Goal
현재 LSTM 모델의 예측 성능이 랜덤 수준(Direction Accuracy 49.91%, Correlation 0.0186)인 원인을 진단하고, feature들의 실제 예측력을 분석하여 개선 방향을 도출한다.

## Background
2025-07-01 ~ 2025-11-30 평가 결과:
- Close Direction Accuracy: **49.91%** (동전 던지기 수준)
- Regression Correlation: **0.0186** (거의 0)
- Classification Accuracy: **30.44%** (4-class 랜덤 25%보다 높음 - 일부 예측력 존재)
- Avg PnL/trade: **-0.176%** (거래할수록 손실)

**Note**: 4-bin classification (CRASH, DOWN, UP, BUST)에서 30.44%는 랜덤(25%)보다 5.44%p 높아 약간의 예측력이 있음.

모델 구조 변경([009-lstm-attention-hybrid](009-lstm-attention-hybrid.md), [008-model-ensemble-uncertainty](008-model-ensemble-uncertainty.md)) 전에 feature 자체의 예측력을 먼저 검증해야 함.

## Scope
- [x] Feature-Target 상관관계 분석
  - 각 feature와 6h 후 수익률 간 Pearson/Spearman correlation 계산
  - Feature 그룹별(가격, 거래량, 기술지표, OI, FR) 상관관계 분석
- [x] Lag별 상관관계 분석
  - 1h, 4h, 6h, 12h, 24h 후 target과의 correlation 비교
  - 최적 prediction horizon 탐색
- [x] Feature Importance 분석
  - 간단한 모델(RandomForest, XGBoost)로 feature importance 추출
  - 불필요한 feature 식별
- [x] Data Leakage 점검
  - Future information이 feature에 포함되었는지 확인
  - Indicator 계산 시점 검증
- [x] 분석 결과 시각화 및 리포트 생성

## Technical Details

### 분석 대상 Features
현재 사용 중인 feature 그룹:
1. **가격 관련**: OHLCV (1h, 1d)
2. **거래량**: Volume, Volume MA
3. **기술지표**: RSI, MACD, Bollinger Bands, ATR, ADX 등
4. **파생상품**: Open Interest (OI), Funding Rate (FR)

### 분석 방법
```python
# 1. Correlation Matrix
correlations = df[features].corrwith(df['target_return_6h'])

# 2. Lag Correlation
for lag in [1, 4, 6, 12, 24]:
    corr = df[features].corrwith(df['target_return'].shift(-lag))

# 3. Feature Importance (Quick Model)
from sklearn.ensemble import RandomForestRegressor
rf = RandomForestRegressor(n_estimators=100)
rf.fit(X, y)
importance = rf.feature_importances_
```

### 결과물
- `notebooks/012_feature_correlation_analysis.ipynb` - 분석 노트북
- `reports/feature_correlation_report.md` - 분석 리포트 (옵션)

## Acceptance Criteria
- [x] 모든 feature의 target 상관관계 계산 완료
- [x] 상관관계 > 0.05인 feature 목록 도출
- [x] 최적 prediction horizon 제안
- [x] Data leakage 여부 확인
- [x] 다음 단계 개선 방향 제안 (feature 추가/제거/horizon 변경)

## Related
- [004-quantile-pnl-output-metrics](004-quantile-pnl-output-metrics.md) - Feature 개선 후 진행
- [009-lstm-attention-hybrid](009-lstm-attention-hybrid.md) - Feature 개선 후 진행
- [008-model-ensemble-uncertainty](008-model-ensemble-uncertainty.md) - Feature 개선 후 진행

## Related Files
- `src/prediction/prediction_model.py` - 현재 모델 구조
- `src/indicators/batch_processor.py` - 기술지표 계산
- `src/database/repositories/` - 데이터 조회
- `notebooks/` - 분석 노트북 위치

---

## Implementation Results

### Key Findings

#### 1. Feature-Target Correlations (6h horizon)
모든 feature의 상관관계가 매우 낮음 (|r| < 0.05):
| Feature | Pearson Corr | P-value |
|---------|-------------|---------|
| weekday_cos | 0.0434 | 1.6e-07 |
| bb_width | -0.0394 | 2.1e-06 |
| macd_hist_norm | 0.0370 | 7.9e-06 |
| btc_eth_corr | -0.0351 | 2.4e-05 |
| atr_14 | -0.0329 | 7.1e-05 |

**핵심 발견**: |correlation| > 0.05인 feature가 **0개**

#### 2. Optimal Prediction Horizon
평균 상관관계 by horizon:
| Horizon | Avg |Correlation| |
|---------|-------------------|
| target_1h | 0.0105 |
| target_4h | 0.0214 |
| target_6h | 0.0185 |
| target_12h | 0.0250 |
| target_24h | 0.0321 |

**⚠️ 주의: 24h 상관관계 증가는 스케일 효과 (Scale Artifact)**

24h에서 높아지는 feature들 (atr_14: 0.146, log_volume: 0.125, bb_width: 0.124)은 모두 **변동성/거래량 관련**이다. 이는 "변동성이 큰 시기에 변동이 크다"는 동어반복(tautology)에 가까우며, 실제 예측력이 아님.

반면 **실제 예측적 feature들은 horizon에 따라 단조증가하지 않음**:
- `macd_hist_norm`: 4h 최고 (0.046), 24h에서 0.003으로 감소
- `rsi_norm`: 4h 최고 (0.035), 24h에서 0.011
- `hour_sin`: 6h 최고 (0.033), 24h에서 0.001
- `funding_rate`: 6h 최고 (0.030)

**결론**: 현재 6h horizon 유지가 적절. horizon 변경보다 **새로운 feature 추가**가 우선

#### 3. Feature Importance (RF + GB combined)
| Feature | Avg Importance |
|---------|---------------|
| btc_eth_corr | 0.210 |
| funding_ma | 0.116 |
| r96 | 0.106 |
| weekday_sin | 0.087 |
| funding_rate | 0.075 |

#### 4. Data Leakage Check
**선행지표로 확인된 features** (leakage_ratio > 2):
- `hour_sin` (10.27) - 시간대별 변동성 패턴 (아시아/유럽/미국 장)
- `weekday_sin` (4.46) - 요일별 변동성 패턴
- `basis_dev` (3.61) - 선물 프리미엄 이탈 → 시장 과열/과매도 신호
- `funding_rate` (2.84) - 펀딩비 → 롱/숏 포지션 불균형 신호

✅ **Data leakage 아님** - 이들은 미래 움직임을 선행하는 유효한 예측 지표
- 높은 funding_rate → 롱 과다 → 이후 하락 경향
- 높은 basis_dev → 선물 과열 → mean reversion 가능성

#### 5. Out-of-Sample Model Performance
Train/Test split: 80/20 (시계열 순서 유지)

| Metric | RandomForest | GradientBoosting | 의미 |
|--------|-------------|------------------|------|
| R² Score | **-0.0559** | **-0.0700** | 음수 = 평균값 예측보다 못함 |
| MAE | 1.0093% | 1.0130% | 평균 절대 오차 (target std ≈ 1%) |
| Correlation | -0.0223 | 0.0000 | 예측-실제 간 선형 관계 없음 |
| Direction Accuracy | 49.60% | 50.33% | 동전 던지기 수준 |

**해석:**
- R² 음수: 모델이 단순 평균 예측보다 못함 → 노이즈 학습
- MAE ≈ target std: 예측 오차가 변동성 전체 수준
- Correlation ≈ 0: 예측값과 실제값 무관
- Direction ≈ 50%: 방향 예측 능력 없음

**결론:** RF/GB도 현재 feature들로는 예측 불가 → LSTM 문제가 아닌 **feature의 한계**

#### 6. 4-Class Classification Performance (추가 분석)
4-bin classification (CRASH, DOWN, UP, BUST) bins: `[-inf, -0.6, 0.0, 0.6, inf]`

| Model | Accuracy | Random Baseline | Improvement |
|-------|----------|-----------------|-------------|
| RandomForest | ~27% | 25% | +2%p |
| GradientBoosting | ~27% | 25% | +2%p |
| LSTM (실제 모델) | **30.44%** | 25% | **+5.44%p** |

**핵심 발견**: LSTM이 RF/GB보다 classification에서 더 좋은 성능 → 시계열 패턴 활용 능력 있음

#### 7. Volatility Regime 분석 (추가 분석)
ATR 기반 변동성 레짐 분류 (33%/67% percentile):

| Regime | 최고 상관관계 Feature | Max |r| |
|--------|----------------------|-------|
| Low Vol | funding_rate | 0.064 |
| Medium Vol | funding_rate | 0.085 |
| High Vol | hour_sin | 0.082 |

**핵심 발견**:
- Medium Vol 레짐에서 funding_rate 상관관계가 가장 높음 (0.085)
- High Vol 레짐에서는 시간 feature(hour_sin, weekday_cos)가 더 예측적
- 레짐별로 다른 feature가 중요 → **Regime-aware 모델 권장**

#### 8. Feature Interaction 분석 (추가 분석)
Top 8 feature 간 곱셈/비율 상호작용:

| Feature 1 | Feature 2 | Max |Correlation| |
|-----------|-----------|-------------------|
| funding_rate | hour_sin | **0.072** |
| r96 | weekday_sin | 0.069 |
| funding_ma | hour_sin | 0.054 |
| funding_rate | bb_width | 0.044 |

**핵심 발견**:
- `funding_rate × hour_sin` 상호작용이 0.072로 개별 feature보다 높음
- 시간 feature와 파생상품 feature의 조합이 예측력 향상에 도움

### Recommendations

#### 즉시 실행 가능
1. **6h horizon 유지** (24h 전환 불필요)
   - 24h 상관관계 증가는 스케일 효과로 인한 착시
   - 실제 예측적 feature들(macd, rsi, funding_rate)은 4-6h에서 최적

2. **Feature Interaction 추가**
   - `funding_rate × hour_sin` (r=0.072)
   - `r96 × weekday_sin` (r=0.069)
   - 개별 feature보다 상호작용이 더 높은 상관관계

1. **Volatility Regime Feature 추가** [015-feature-interaction-regime](015-feature-interaction-regime.md)
   - ATR 기반 레짐 분류 feature
   - 레짐별로 다른 feature가 중요함을 활용

#### 중기 과제 (우선순위 높음)
4. **새로운 데이터 소스 추가 필요** ← 가장 중요
   - OHLCV 테이블에 있는 volume_buy, volume_sell 활용 (이미 있음)
   - Order book imbalance (매수/매도 압력)
   - Whale transaction data
   - Social sentiment indicators
   - Cross-exchange arbitrage signals
   - 현재 feature들의 상관관계가 너무 낮아 (max 0.043) 근본적 개선 필요

#### 기대 효과
- Feature interactions + regime features로 소폭 개선 가능 (32-33% 예상)
- 새로운 데이터 소스 추가 시 35%+ 달성 가능성
- 이후 [004-quantile-pnl-output-metrics](004-quantile-pnl-output-metrics.md) 진행 권장

### Changed Files
| File | Changes |
|------|---------|
| `notebooks/012_feature_correlation_analysis.ipynb` | 전체 분석 노트북 (14,593 샘플, 26 features, 5 horizons, 9 parts) |
| `notebooks/correlation_6h.csv` | 6h horizon 상관관계 결과 |
| `notebooks/horizon_comparison.csv` | 다중 horizon 비교 결과 |
| `notebooks/feature_importance.csv` | RF/GB feature importance |
| `notebooks/leakage_check.csv` | Data leakage 점검 결과 |
| `notebooks/feature_target_correlations.png` | 상관관계 시각화 |
| `notebooks/horizon_comparison_heatmap.png` | Horizon별 상관관계 히트맵 |
| `notebooks/feature_importance.png` | Feature importance 시각화 |
| `notebooks/classification_confusion_matrix.png` | 4-class confusion matrix (추가) |
| `notebooks/regime_correlations.png` | 레짐별 상관관계 시각화 (추가) |
| `notebooks/regime_correlation.csv` | 레짐별 상관관계 데이터 (추가) |
| `notebooks/feature_interactions.csv` | Feature 상호작용 분석 (추가) |

### Lessons Learned / Issues
- **BTC 6h 예측은 매우 어려운 문제** - 현재 feature들로는 거의 불가능
- **⚠️ 24h 상관관계 증가는 스케일 효과** - 변동성 feature(atr_14, bb_width)가 긴 horizon에서 높아지는 것은 예측력이 아니라 "변동성 큰 시기에 변동이 크다"는 동어반복
- **실제 예측적 feature들은 4-6h에서 최적** - macd_hist_norm, rsi_norm, funding_rate 등
- 시간 feature(hour_sin, weekday_sin)의 leakage ratio가 높은 것은 주의 필요하나, 시간대별 변동성 차이를 반영하는 것이므로 자연스러움
- RandomForest/GradientBoosting도 이 feature들로는 예측 불가 → LSTM의 문제가 아닌 **feature의 문제**
- **LSTM이 RF/GB보다 classification에서 더 나은 성능** (30.44% vs ~27%) → 시계열 패턴 활용 능력 있음
- **레짐별 feature 중요도가 다름** → Regime-aware 모델 접근 필요
- **Feature interaction**이 개별 feature보다 높은 상관관계 (0.072 vs 0.043) → 상호작용 feature 추가 권장

### Follow-up
* [013-volume-buy-sell-features](013-volume-buy-sell-features.md)
- [014-add-more-data-source](014-add-more-data-source.md)
- [015-feature-interaction-regime](015-feature-interaction-regime.md) - Feature interaction + regime feature 추가 실험 (생성 필요)
- [004-quantile-pnl-output-metrics](004-quantile-pnl-output-metrics.md) - Feature 개선 후 진행
- [009-lstm-attention-hybrid](009-lstm-attention-hybrid.md) - Feature 개선 후 진행

### Completed
2025-12-19

