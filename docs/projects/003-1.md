---
nav_order: 10
parent: 프로젝트
title: '[DONE] 003 - Selective Trading: Gate + Action Heads'
description: "LSTM 예측 모델에 Gate/Action 헤드 추가. 선택적 트레이딩 구조 구현. Focal Loss로 클래스 불균형 해결. 거래 성과 기반 평가 지표."
---

# 003 - Selective Trading: Gate + Action Heads
{:.no_toc}

## 목차
{:.no_toc}

1. TOC
{:toc}

---

| 상태 | 생성일 | 수정일 |
|------|--------|--------|
| completed | 2025-12-18 | - |

---

## Summary

LSTM 예측 모델에 Gate(거래/비거래) 헤드와 Action(LONG/SHORT/NO_TRADE) 헤드를 추가하여 **선택적 트레이딩** 구조를 구현한다. 기존의 "모든 시점에서 방향 예측" 방식에서 "거래할 만한 구간만 선별" 방식으로 전환하는 첫 번째 단계.

## Background

### Current State
- 현재 모델: 4-class 분류 (CRASH, DOWN, UP, BUST) + Regression (min/max/close return)
- 문제점: 모든 시점에서 방향을 예측하지만, 대부분의 시점은 거래하기에 적합하지 않음
- 결과: 낮은 정밀도(precision), 불필요한 거래 신호 과다 발생

### Target State
- Gate 헤드: P(trade) 출력 - 해당 시점에서 거래할 가치가 있는지 판단
- Action 헤드: P(NO_TRADE), P(LONG), P(SHORT) - 어떤 포지션을 취할지 결정
- Gate가 높은 시점에서만 Action에 따라 거래 실행

## Implementation Plan

### Phase 1: Label Engineering (타깃 라벨 생성)

1. **PnL 기반 라벨 계산**
   ```python
   # 거래 비용 (수수료 + 슬리피지)
   TRADING_COST = 0.1  # 0.1% (양방향 0.05% 가정)
   EDGE_THRESHOLD = 0.3  # 최소 기대 수익률 %

   # t 시점에서 t+H 까지의 수익률
   pnl_long = close_ret_pct - TRADING_COST
   pnl_short = -close_ret_pct - TRADING_COST

   best_pnl = max(pnl_long, pnl_short)

   # Gate 라벨: 최적 포지션의 PnL이 임계치 이상이면 거래 가치 있음
   gate_label = 1 if best_pnl >= EDGE_THRESHOLD else 0

   # Action 라벨: 0=NO_TRADE, 1=LONG, 2=SHORT
   if gate_label == 0:
       action_label = 0  # NO_TRADE
   elif pnl_long >= pnl_short:
       action_label = 1  # LONG
   else:
       action_label = 2  # SHORT
   ```

2. **parse_training_features 수정**
   - `gate_y`: (samples,) - binary label
   - `action_y`: (samples, 3) - one-hot encoded

### Phase 2: Model Architecture 수정

1. **새로운 헤드 추가** (`create_model_lstm` 수정)
   ```python
   # Gate head: sigmoid output for P(trade)
   gate_dense = Dense(LSTM_UNITS // 2, activation='relu', name='gate_dense')(shared_dropout)
   gate = Dense(1, activation='sigmoid', name='gate')(gate_dense)

   # Action head: softmax over [NO_TRADE, LONG, SHORT]
   action_dense = Dense(LSTM_UNITS // 2, activation='relu', name='action_dense')(shared_dropout)
   action = Dense(3, activation='softmax', name='action')(action_dense)
   ```

2. **손실 함수 설계**
   ```python
   # Gate loss: Focal Loss (불균형 문제 해결)
   def focal_loss(gamma=FOCAL_GAMMA, alpha=FOCAL_ALPHA):
       def focal_loss_fn(y_true, y_pred):
           y_pred = K.clip(y_pred, K.epsilon(), 1 - K.epsilon())
           pt = y_true * y_pred + (1 - y_true) * (1 - y_pred)
           alpha_t = y_true * alpha + (1 - y_true) * (1 - alpha)
           focal_weight = alpha_t * K.pow(1 - pt, gamma)
           loss = -focal_weight * K.log(pt)
           return K.mean(loss)
       return focal_loss_fn

   # Action loss: Categorical Cross-Entropy
   ```

3. **기존 헤드 유지**
   - cls_close, cls_high, cls_low, reg 헤드는 그대로 유지
   - 점진적 전환을 위해 기존 평가도 병행

### Phase 3: Training Pipeline 수정

1. **compile 수정**
   ```python
   loss = {
       'gate': 'binary_crossentropy',
       'action': 'categorical_crossentropy',
       'cls_close': 'categorical_crossentropy',
       ...
   }

   loss_weights = {
       'gate': LAMBDA_GATE,
       'action': LAMBDA_ACTION,
       ...
   }
   ```

2. **Callbacks 추가**
   - Gate precision/recall 모니터링
   - Action accuracy (gate=1 샘플 한정) 모니터링

### Phase 4: Evaluation Metrics 추가

1. **Trading-focused 지표**
   ```python
   # Coverage: 거래 신호 비율
   coverage = np.mean(gate_pred > 0.5)

   # Expected PnL per trade
   trades = gate_pred > 0.5
   avg_pnl = np.mean(actual_pnl[trades])

   # Hit rate: 수익 난 거래 비율
   hit_rate = np.mean(actual_pnl[trades] > 0)

   # Precision@k: 상위 k% 확신도에서의 성과
   top_k_indices = np.argsort(gate_pred)[-k:]
   precision_at_k = np.mean(actual_pnl[top_k_indices] > 0)
   ```

2. **run_evaluation 수정**
   - Gate/Action 분류 성능 추가
   - PnL 기반 성과 지표 추가

## Testing Strategy

1. **Unit Tests**
   - Label 생성 로직 검증
   - Gate/Action 출력 shape 검증
   - Loss 계산 검증

2. **Integration Tests**
   - 전체 training pipeline 실행
   - 기존 모델과 출력 호환성 확인

3. **Evaluation Comparison**
   - 기존 모델 vs Gate+Action 모델 성과 비교
   - 동일 데이터로 backtest 수행

## Configuration

```python
# Selective Trading Configuration
TRADING_COST = 0.1        # 거래 비용 % (양방향 수수료 + 슬리피지)
EDGE_THRESHOLD = 0.3      # 최소 기대 수익률 %
LAMBDA_GATE = 1.0         # Gate loss weight
LAMBDA_ACTION = 1.0       # Action loss weight
GATE_THRESHOLD = 0.5      # Inference time threshold

# Focal Loss Configuration
FOCAL_GAMMA = 2.0         # Focal loss focusing parameter (높을수록 어려운 샘플에 집중)
FOCAL_ALPHA = 0.25        # Focal loss class balance weight (gate=1 클래스 가중치)
```

## Risks & Mitigations

| Risk | Mitigation |
|------|------------|
| Gate=1 샘플 불균형 | **Focal Loss 적용** (gamma=2.0, alpha=0.25) |
| Action 붕괴 (모두 NO_TRADE 예측) | Gate=1 샘플에서만 Action loss 강조 |
| 기존 성능 저하 | 기존 헤드 유지하며 점진적 전환 |

## Success Criteria

- [ ] Gate precision@10% >= 60% (상위 10% 신호 중 60% 이상 수익)
- [ ] Action accuracy (gate=1) >= 55%
- [ ] Coverage 10-30% (전체 시점 중 거래 신호 비율)
- [ ] Average PnL per trade > 0 (거래 비용 차감 후)

## Files to Modify

- `src/prediction/prediction_model.py`
  - `parse_training_features()` - 라벨 추가
  - `create_model_lstm()` - Gate/Action 헤드 추가
  - `_train_model()` - 손실함수/metrics 수정
  - `run_evaluation()` - 평가 지표 추가

## Dependencies

- 기존 데이터 파이프라인 그대로 사용
- 추가 외부 라이브러리 없음

## Estimated Scope

- 라벨 생성: ~50 lines
- 모델 수정: ~30 lines
- 훈련 수정: ~30 lines
- 평가 수정: ~100 lines
- 테스트: ~50 lines
- **Total: ~260 lines**

## References

- model-poc.md (기존 모델 설계 문서)
- 요청 문서: PnL 중심 평가/학습 전환 아이디어

## Related Tickets

- [004-quantile-pnl-output-metrics](004-quantile-pnl-output-metrics.md) - 후속 작업
- [005-backtesting-framework](005-backtesting-framework.md) - 검증에 필요
- ~~[006-advanced-loss-functions](006-advanced-loss-functions.md)~~ - Focal Loss는 이 티켓에서 구현

---

## Implementation Summary

### Branch
`003-selective-trading-gate`

### Changed Files
- `src/prediction/prediction_model.py` (+274, -66 lines)

### Key Changes
1. **상수 추가**: `TRADING_COST`, `EDGE_THRESHOLD`, `LAMBDA_GATE`, `LAMBDA_ACTION`, `FOCAL_GAMMA`, `FOCAL_ALPHA`, `GATE_THRESHOLD`
2. **Focal Loss 함수**: `focal_loss()` - Gate 불균형 해결용
3. **라벨 생성**: `parse_training_features()`에 `gate_y`, `action_y` 추가
4. **모델 헤드**: `create_model_lstm()`에 Gate/Action 헤드 추가 (6개 출력)
5. **학습 파이프라인**: `_split_train_val()`, `_train_model()` 수정
6. **평가 메트릭**: `run_evaluation()`에 trading_metrics 추가

### Trading Metrics Added
- `coverage`: 거래 신호 비율
- `gate_precision`, `gate_recall`: Gate 분류 성능
- `action_accuracy_gated`: Gate=1인 샘플에서 Action 정확도
- `avg_pnl_per_trade`: 거래당 평균 PnL
- `hit_rate`: 수익 거래 비율
- `precision_at_10pct`: 상위 10% 신호의 수익률

### Verification
- Python 문법 검증 통과
- 상수/함수 import 테스트 통과
- 모델 생성 테스트 통과 (6개 출력 확인)
- Focal Loss 함수 테스트 통과

### Next Steps
- [ ] 실제 데이터로 학습 실행
- [ ] 성공 기준 달성 여부 확인
- [ ] 필요시 하이퍼파라미터 튜닝

