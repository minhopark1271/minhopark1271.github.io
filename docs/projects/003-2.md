---
nav_order: 30
parent: 프로젝트
title: '[DONE] 003-2 - Simplify Prediction Heads: Close-only Classification + 2-var
  Regression'
description: "예측 모델 헤드 단순화. min/max 분류 제거, close만 분류 + 2변수 회귀(close, mid)로 변경. 학습 시간 단축."
---

# 003-2 - Simplify Prediction Heads: Close-only Classification + 2-var Regression
{:.no_toc}

## 목차
{:.no_toc}

1. TOC
{:toc}

---

| 상태 | 생성일 | 수정일 |
|------|--------|--------|
| completed | 2025-12-18 | - |

---

## Summary

예측 헤드를 단순화한다. min/max/close 각각에 대한 binning 분류는 실용적 의미가 적으므로, **close만 분류**하고 **regression은 close와 mid_return ((min+max)/2) 두 가지만 예측**하도록 수정한다.

## Background

### Current State
- **분류 헤드 3개**: `cls_close`, `cls_high`, `cls_low` - 각각 close/high/low return을 binning하여 분류
- **회귀 헤드 1개**: `reg` - `[min_return, max_return, close_return]` 3개 값 예측
- **Gate/Action 헤드**: 유지 (003 티켓에서 추가됨)

### Problems
1. `cls_high`, `cls_low` 분류는 트레이딩 의사결정에 직접적인 활용이 어려움
2. High/Low binning의 의미가 불명확 (방향성 예측이 아님)
3. 모델 복잡도 증가 대비 실질적 효용 낮음
4. min_return, max_return 개별 예측보다 mid_return이 변동성 지표로 더 유용

### Target State
- **분류 헤드 1개**: `cls_close` only
- **회귀 헤드 1개**: `reg` - `[close_return, mid_return]` 2개 값만 예측
  - `mid_return = (min_return + max_return) / 2` (기간 내 평균 가격 변동률)
- **Gate/Action 헤드**: 유지

## Implementation Plan

### Phase 1: 라벨 생성 수정 (`parse_training_features`)

1. **제거할 항목**
   - `cls_high_y`, `cls_low_y` 배열 생성 로직
   - `HIGH_BINS`, `LOW_BINS`, `HIGH_BIN_LABELS`, `LOW_BIN_LABELS` 관련 코드

2. **수정할 항목**
   ```python
   # Before
   reg_y = np.empty((num_valid_samples, 3), dtype=np.float32)
   reg_y[sample_idx, 0] = (min_price / price_t) - 1
   reg_y[sample_idx, 1] = (max_price / price_t) - 1
   reg_y[sample_idx, 2] = (price_target / price_t) - 1

   # After
   reg_y = np.empty((num_valid_samples, 2), dtype=np.float32)
   min_return = (min_price / price_t) - 1
   max_return = (max_price / price_t) - 1
   reg_y[sample_idx, 0] = (price_target / price_t) - 1  # close_return
   reg_y[sample_idx, 1] = (min_return + max_return) / 2  # mid_return
   ```

3. **반환값 수정**
   ```python
   # Remove from result dict
   # 'cls_high_y', 'cls_low_y', 'cls_high_labels', 'cls_low_labels'

   # Update reg_labels
   reg_labels = ['close_return', 'mid_return']
   ```

### Phase 2: 모델 아키텍처 수정 (`create_model_lstm`)

1. **제거할 헤드**
   ```python
   # Remove cls_high head
   cls_high_dense = Dense(...)  # DELETE
   cls_high_logits = Dense(...)  # DELETE
   cls_high = Lambda(...)  # DELETE

   # Remove cls_low head
   cls_low_dense = Dense(...)  # DELETE
   cls_low_logits = Dense(...)  # DELETE
   cls_low = Lambda(...)  # DELETE
   ```

2. **회귀 헤드 수정**
   ```python
   # Before
   reg = Dense(3, activation='linear', name='reg')(reg_dense)

   # After
   reg = Dense(2, activation='linear', name='reg')(reg_dense)
   ```

3. **모델 출력 수정**
   ```python
   # Before
   outputs=[cls_close, cls_high, cls_low, reg, gate, action]

   # After
   outputs=[cls_close, reg, gate, action]
   ```

4. **함수 시그니처 수정**
   ```python
   # Before
   def create_model_lstm(self, base_features: int, num_close_classes: int = None,
                          num_high_classes: int = None, num_low_classes: int = None)

   # After
   def create_model_lstm(self, base_features: int, num_close_classes: int = None)
   ```

### Phase 3: 학습 파이프라인 수정

1. **`_split_train_val` 수정**
   ```python
   # Before
   def _split_train_val(self, X, y_cls_close, y_cls_high, y_cls_low, y_reg, y_gate, y_action, ...)

   # After
   def _split_train_val(self, X, y_cls_close, y_reg, y_gate, y_action, ...)
   ```

2. **`_train_model` 수정**
   - 손실 함수에서 `cls_high`, `cls_low` 제거
   - loss_weights에서 `LAMBDA_CLS_HIGH`, `LAMBDA_CLS_LOW` 제거
   - metrics에서 관련 항목 제거

3. **상수 정리**
   ```python
   # Remove
   HIGH_BINS, LOW_BINS, HIGH_BIN_LABELS, LOW_BIN_LABELS
   LAMBDA_CLS_HIGH, LAMBDA_CLS_LOW
   ```

### Phase 4: 추론 및 평가 수정

1. **`_infer` 수정**
   ```python
   # Before
   return cls_close_pred, cls_high_pred, cls_low_pred, reg_pred, gate_pred, action_pred

   # After
   return cls_close_pred, reg_pred, gate_pred, action_pred
   ```

2. **`run_evaluation` 수정**
   - High/Low 분류 평가 제거
   - Regression 평가를 2개 변수로 수정 (`close_return`, `mid_return`)
   - 상관계수 계산 및 출력 수정

3. **`run_batch_inference` 수정**
   - 반환값에서 `cls_high_pred`, `cls_low_pred` 제거

### Phase 5: 시각화 및 기타 수정

1. **`plot_prediction_scatter` 수정**
   - 3개 subplot에서 2개로 변경 (`close_return`, `mid_return`)

2. **API/Dashboard 연동 확인**
   - 예측 결과 포맷 변경에 따른 수정 필요 여부 확인

## Files to Modify

- `src/prediction/prediction_model.py`
  - `parse_training_features()` - 라벨 생성 로직 수정
  - `create_model_lstm()` - 모델 아키텍처 수정
  - `_split_train_val()` - 시그니처 및 로직 수정
  - `_train_model()` - 손실함수/metrics 수정
  - `_infer()` - 추론 로직 수정
  - `run_evaluation()` - 평가 로직 수정
  - `run_batch_inference()` - 배치 추론 수정
  - `plot_prediction_scatter()` - 시각화 수정
  - 상수 정리 (파일 상단)

## Configuration Changes

```python
# Remove
HIGH_BINS = [-float('inf'), -1.5, -0.5, 0.5, 1.5, float('inf')]
LOW_BINS = [-float('inf'), -1.5, -0.5, 0.5, 1.5, float('inf')]
HIGH_BIN_LABELS = ['CRASH', 'DIP', 'STABLE', 'RALLY', 'BURST']
LOW_BIN_LABELS = ['CRASH', 'DIP', 'STABLE', 'RALLY', 'BURST']
LAMBDA_CLS_HIGH = 1.0
LAMBDA_CLS_LOW = 1.0

# Keep
BINS = [-float('inf'), -1.0, -0.3, 0.3, 1.0, float('inf')]  # For close
BIN_LABELS = ['CRASH', 'DOWN', 'NEUTRAL', 'UP', 'BURST']
LAMBDA_CLS_CLOSE = 1.0
```

## Testing Strategy

1. **Unit Tests**
   - `parse_training_features()` 출력 shape 검증 (reg_y: (N, 2))
   - `create_model_lstm()` 출력 개수 검증 (4개: cls_close, reg, gate, action)
   - mid_return 계산 검증

2. **Integration Tests**
   - 전체 training pipeline 실행
   - 저장된 모델 로드 및 추론

3. **Regression Tests**
   - 기존 테스트 중 High/Low 관련 테스트 제거 또는 수정

## Breaking Changes

- **모델 출력 개수 변경**: 6개 → 4개
- **기존 저장된 모델과 호환 불가** - 새로 학습 필요
- **API 응답 포맷 변경 가능** - cls_high_pred, cls_low_pred 제거

## Success Criteria

- [ ] 모델 출력이 4개 (cls_close, reg, gate, action)
- [ ] reg 출력이 2개 (close_return, mid_return)
- [ ] 기존 대비 학습 시간 단축 (헤드 2개 제거)
- [ ] close 분류 정확도 유지 또는 개선
- [ ] Python syntax 검증 통과
- [ ] 기존 테스트 수정 후 통과

## Estimated Scope

- 라벨 생성 수정: ~30 lines removed, ~10 lines modified
- 모델 수정: ~20 lines removed, ~5 lines modified
- 학습 수정: ~40 lines removed, ~20 lines modified
- 평가 수정: ~50 lines removed, ~20 lines modified
- 시각화 수정: ~10 lines modified
- **Total: ~140 lines removed, ~65 lines modified**

## Dependencies

- 003 티켓 완료 필요 (Gate/Action 헤드 기반)
- 기존 데이터 파이프라인 변경 없음

## Related Tickets

- [003-1-selective-trading-gate-action](003-1-selective-trading-gate-action.md) - 선행 작업 (완료)
- [004-quantile-pnl-output-metrics](004-quantile-pnl-output-metrics.md) - 평가 지표 관련

---

## Implementation Summary

### Branch
`003-2-simplify-prediction-heads`

### Changed Files
- `src/prediction/prediction_model.py` (+103, -248 lines)

### Key Changes
1. **상수 제거**: `HIGH_BINS`, `LOW_BINS`, `HIGH_BIN_LABELS`, `LOW_BIN_LABELS`, `LAMBDA_CLS_HIGH`, `LAMBDA_CLS_LOW`
2. **라벨 생성**: `parse_training_features()`에서 cls_high_y, cls_low_y 제거, reg_y를 `[close_return, mid_return]`으로 변경
3. **모델 헤드**: `create_model_lstm()`에서 cls_high, cls_low 헤드 제거 (6개 → 4개 출력)
4. **회귀 출력**: `Dense(3)` → `Dense(2)` (close_return, mid_return)
5. **학습/추론 파이프라인**: 모든 관련 함수 시그니처 및 로직 수정
6. **평가/시각화**: run_evaluation(), plot_evaluation_charts() 수정

### Verification
- Python 문법 검증 통과
- 상수/함수 import 테스트 통과
- 모델 생성 테스트 통과 (4개 출력 확인: cls_close, reg, gate, action)

### Success Criteria Achieved
- [x] 모델 출력이 4개 (cls_close, reg, gate, action)
- [x] reg 출력이 2개 (close_return, mid_return)
- [x] Python syntax 검증 통과
- [ ] 기존 대비 학습 시간 단축 - 실제 학습으로 검증 필요
- [ ] close 분류 정확도 유지 또는 개선 - 실제 학습으로 검증 필요

### Next Steps
- [ ] 실제 데이터로 학습 실행
- [ ] 성공 기준 달성 여부 확인
- [ ] API/Dashboard 연동 확인 (필요시 수정)

